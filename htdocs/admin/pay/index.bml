<html>
<head><title>Payment Management</title></head>
<body>

<?_code
{
    use strict;
    use vars qw(%GET %POST);

    my $remote = LJ::get_remote();
    my @displayprivs = ( "payments" );
    my $numprivs = @displayprivs;

    return "<?needlogin?>" unless $remote; 
    return BML::ml( "admin.noprivserror", { numprivs => $numprivs, needprivs => "<b>" . join(", ", @displayprivs) . "</b>"} )
        unless LJ::check_priv($remote, 'payments');

    my $body = '<h1>Payment Manager</h1>';

    if ($GET{view}) {
        $body .= '<p>[ <a href="/admin/pay/index.bml">&lt;&lt; Back to Index</a> ]</p>';

        # allow editing a user's paid status
        my $u = LJ::load_user( $GET{view} );
        return "User does not exist.\n"
            unless $u;

        my $ps = DW::Pay::get_paid_status( $u );
        if ( $ps ) {
            $body .= '<h2>Paid Status</h2>';
            $body .= LJ::ljuser( $u ) . ": " . DW::Pay::type_name( $ps->{typeid} );

            if ( $ps->{permanent} ) {
                $body .= '; <strong>Permanent Status</strong> will never expire.';

            } else {
                if ( $ps->{expiresin} > 0 ) {
                    my $expt = LJ::mysql_time( $ps->{expiretime} );
                    my $exp = LJ::ago_text( $ps->{expiresin} );
                    $exp =~ s/ ago//;
                    $body .= "; expires $expt (<strong>$exp</strong>).";

                } else {
                    $body .= '; <strong>expired</strong>.';

                }
            }

        } else {
            $body .= '<p>User has never had a paid account of any kind.</p>';

        }

        $body .= qq|<p><a href="/admin/statushistory.bml?user=$u->{user}">View statushistory for user.</a></p>|;

        $body .= "<h2>View Carts</h2>";

        my @carts = DW::Shop::Cart->get_all( $u );

        if ( @carts ) {
            $body .= "<table border='1'>";
            $body .= "<tr><th>Cart Number</th><th>Date</th><th>Total</th>";
            $body .= "<th>Payment Method</th><th>Status</th><th>Details</th>";
            foreach my $cart ( @carts ) {
                my $state = $cart->state;
                my $paymentmethod = $cart->paymentmethod;
                my $paystr = ( $paymentmethod ?
                                   $ML{"/shop/receipt.bml.cart.paymentmethod.$paymentmethod"} :
                                   "(not yet selected)" );
                my $date = DateTime->from_epoch( epoch => $cart->starttime );

                my $detailstext = "Details";
                $detailstext .= " / Mark as Payment Received" if $state == $DW::Shop::STATE_PEND_PAID;

                $body .= "<tr>";
                $body .= "<td>" . $cart->id . "</td>";
                $body .= "<td>" . $date->strftime( "%F %r %Z" ) . "</td>";
                $body .= "<td>\$" . $cart->total . " USD</td>";
                $body .= "<td>$paystr</td>";
                $body .= "<td>$ML{\"/shop/receipt.bml.cart.status.$state\"}</td>";
                $body .= "<td><a href='$LJ::SITEROOT/admin/pay/view?cartid=" . $cart->id . "'>$detailstext</a></td>";
                $body .= "</tr>";
            }
            $body .= "</table>";
        }
        else {
            $body .= "<p>This user has not made any orders.</p>";
        }

    } else {
        # print the basic form
        $body .= <<EOF;

<ul>
    <li>Edit user:
      <form method="get" action="/admin/pay/index">
      <input type="text" name="view" /> <input type="submit" value="Go" />
      </form>
    </li>
    <li>View cart/order ID:
      <form method="get" action="/admin/pay/view">
      <input type="text" name="cartid" /> <input type="submit" value="Go" />
      </form>
    </li>
</ul>

EOF

    }

    return $body;
}
_code?>

</body>
</html>
