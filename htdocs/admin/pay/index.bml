<html>
<head><title>Payment Management</title></head>
<body>

<?_code
{
    use strict;
    use vars qw(%GET %POST);

    my $remote = LJ::get_remote();
    return "You don't have access to do that.\n"
        unless LJ::check_priv($remote, 'payments');

    my $body = '<h1>Payment Manager</h1>';

    if ($GET{view}) {
        $body .= '<p>[ <a href="/admin/pay/index.bml">&lt;&lt; Back to Index</a> ]</p>';

        # allow editing a user's paid status
        my $u = LJ::load_user( $GET{view} );
        return "User does not exist.\n"
            unless $u;

        my @actions = ();
        my $ps = DW::Pay::get_paid_status( $u );
        if ( $ps ) {
            $body .= '<h2>Paid Status</h2>';
            $body .= LJ::ljuser( $u ) . ": " . DW::Pay::type_name( $ps->{typeid} );

            if ( $ps->{permanent} ) {
                $body .= '; <strong>Permanent Status</strong> will never expire.';
                push @actions, '', 'Use the override section to change account type';

            } else {
                if ( $ps->{expiresin} > 0 ) {
                    my $expt = LJ::mysql_time( $ps->{expiretime} );
                    my $exp = LJ::ago_text( $ps->{expiresin} );
                    $exp =~ s/ ago//;
                    $body .= "; expires $expt (<strong>$exp</strong>).";

                    if ( $ps->{typeid} == 1 ) {
                        push @actions, 'set-premium', 'Change type to Premium Paid Account';
                    } else {
                        push @actions, 'set-basic', 'Change type to Basic Paid Account';
                    }

                    push @actions, 'extend-6', 'Extend existing type by 6 months',
                                   'extend-12', 'Extend existing type by 12 months';

                } else {
                    $body .= '; <strong>expired</strong>.';

                    push @actions, '', 'Use the override section to give user a different account type';
                }
            }

        } else {
            $body .= '<p>User has never had a paid account of any kind.</p>';

            push @actions, '', 'Use the override section to give user a paid account';
        }

        $body .= qq|<p><a href="/admin/statushistory.bml?user=$u->{user}">View statushistory for user.</a></p>|;

        $body .= "<h2>Edit Status</h2>";

        $body .= "<ul>";
        while (my ($type, $name) = (shift @actions, shift @actions)) {
            last unless $name;

            if ( $type ne '' ) {
                $body .= qq|<li><a href="/admin/pay/index.bml?edit=$u->{user}&act=$type">$name</a></li>|;
            } else {
                $body .= "<li>$name</li>";
            }
        }
        $body .= "</ul>";

        $body .= "<h2>Hardcore Override</h2><p>These actions will change the paid status with no regard " .
                 "for the existing paid status.  Their existing status will be thrown away!</p>";
        $body .= "<ul>";

        @actions = ('override-free', 'Override: reset to free account status',
                    'override-basic-6', 'Override: 6 months Basic Paid status',
                    'override-basic-12', 'Override: 12 months Basic Paid status',
                    'override-basic-99', 'Override: permanent Basic Paid status',
                    'override-premium-6', 'Override: 6 months Premium Paid status',
                    'override-premium-12', 'Override: 12 months Premium Paid status',
                    'override-premium-99', 'Override: permanent Premium Paid status',);
        while (my ($type, $name) = (shift @actions, shift @actions)) {
            last unless $type;

            $body .= qq|<li><a href="/admin/pay/index.bml?edit=$u->{user}&act=$type">$name</a></li>|;
        }

        $body .= "</ul>";

    } elsif ($GET{edit}) {
        $body .= '<p>[ <a href="/admin/pay/index.bml">&lt;&lt; Back to Index</a> ]</p>';

        # allow editing a user's paid status
        my $u = LJ::load_user( $GET{edit} );
        return "User does not exist.\n"
            unless $u;

        my $what = $GET{act};
        return "No action.\n"
            unless $what;

        unless ( LJ::did_post() ) {
            $body .= "<h2>CONFIRM</h2><p>You must confirm that you wish to take action <b>$what</b> on " . LJ::ljuser( $u ) . ".</p>";
            $body .= "<form method='post' action='/admin/pay/index.bml?edit=$u->{user}&act=$what'>";
            $body .= "<input type='submit' value='Confirmed!'>";
            $body .= "</form>";
            return $body;
        }

        my $note = sub {
            LJ::statushistory_add( $u, $remote, 'paidstatus', sprintf( shift, @_ ) );
        };

        my $ps = DW::Pay::get_paid_status( $u );

        if ( $what eq 'override-free' ) {
            DW::Pay::update_paid_status( $u, permanent => 0, expiretime => 0 );
            $note->( "Override: reverted to free." );
        } elsif ( $what eq 'override-basic-6' ) {
            DW::Pay::update_paid_status( $u, permanent => 0, typeid => 1, _set_months => 6 );
            $note->( "Override: set to 6 months Basic." );
        } elsif ( $what eq 'override-basic-12' ) {
            DW::Pay::update_paid_status( $u, permanent => 0, typeid => 1, _set_months => 12 );
            $note->( "Override: set to 12 months Basic." );
        } elsif ( $what eq 'override-basic-99' ) {
            DW::Pay::update_paid_status( $u, permanent => 1, typeid => 1 );
            $note->( "Override: set to permanent Basic." );
        } elsif ( $what eq 'override-premium-6' ) {
            DW::Pay::update_paid_status( $u, permanent => 0, typeid => 2, _set_months => 6 );
            $note->( "Override: set to 6 months Premium." );
        } elsif ( $what eq 'override-premium-12' ) {
            DW::Pay::update_paid_status( $u, permanent => 0, typeid => 2, _set_months => 12 );
            $note->( "Override: set to 12 months Premium." );
        } elsif ( $what eq 'override-premium-99' ) {
            DW::Pay::update_paid_status( $u, permanent => 1, typeid => 2 );
            $note->( "Override: set to permanent Premium." );
        } elsif ( $what eq 'extend-6' ) {
            DW::Pay::update_paid_status( $u, _add_months => 6 );
            $note->( "Override: added 6 months to existing type." );
        } elsif ( $what eq 'extend-12' ) {
            DW::Pay::update_paid_status( $u, _add_months => 12 );
            $note->( "Override: added 12 months to existing type." );
        } else {
            return "Invalid action.\n";
        }

        DW::Pay::sync_caps( $u );

        BML::redirect( "$LJ::SITEROOT/admin/pay/index.bml?view=$u->{user}" );

    } elsif ($GET{show} eq 'summary') {
        $body .= '<p>[ <a href="/admin/pay/index.bml">&lt;&lt; Back to Index</a> ]</p>';

        # show summary of payment information, i.e. how many accounts there are,
        # of what types, and how many payments have been received broken down on a
        # daily basis (last week) and monthly basis (forever)

        my $dbr = DW::Pay::get_db_reader();

        my $rows = $dbr->selectall_arrayref( q{
                SELECT DATE_FORMAT(FROM_UNIXTIME(paydate), '%m-%d'), typeid, duration, COUNT(*), SUM(amount)
                FROM dw_payments
                WHERE paydate > UNIX_TIMESTAMP() - 86400*8
                      AND status = 'paid-completed'
                GROUP BY 1, 2, 3
                ORDER BY 1 DESC, 2, 3
            } );

        $body .= '<h2>Past 7 Days</h2>';
        $body .= '<table border="1"><tr><td>day</td><td>type</td><td>duration</td><td>sold</td><td>revenue</td></tr>';
        foreach my $row ( @{ $rows || [] } ) {
            $body .= "<tr><td>$row->[0]</td><td>" . DW::Pay::type_name( $row->[1] ) . "</td><td>$row->[2]</td>" .
                     "<td>$row->[3]</td><td>\$$row->[4].00</td></tr>";
        }
        $body .= '</table>';

        my $rows = $dbr->selectall_arrayref( q{
                SELECT DATE_FORMAT(FROM_UNIXTIME(paydate), '%m-%Y'), typeid, duration, COUNT(*), SUM(amount)
                FROM dw_payments
                WHERE status = 'paid-completed'
                GROUP BY 1, 2, 3
                ORDER BY 1 DESC, 2, 3
            } );

        $body .= '<h2>All Time</h2>';
        $body .= '<table border="1"><tr><td>month</td><td>type</td><td>duration</td><td>sold</td><td>revenue</td></tr>';
        foreach my $row ( @{ $rows || [] } ) {
            $body .= "<tr><td>$row->[0]</td><td>" . DW::Pay::type_name( $row->[1] ) . "</td><td>$row->[2]</td>" .
                     "<td>$row->[3]</td><td>\$$row->[4].00</td></tr>";
        }
        $body .= '</table>';

    } else {
        # print the basic form
        $body .= <<EOF;

<form method="get" action="/admin/pay/index.bml">

<ul>
    <li><a href="/admin/pay/index.bml?show=summary">Complete payment summary</a></li>
    <li>Edit user: <input type="text" name="view" /> <input type="submit" value="Go" /></li>
</ul>

EOF

    }

    return $body;
}
_code?>

</body>
</html>
