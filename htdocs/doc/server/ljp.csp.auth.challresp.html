<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>3. Challenge-Response</title>
<link rel="stylesheet" href="style.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.73.2">
<link rel="start" href="index.html" title="LiveJournal Server">
<link rel="up" href="ljp.csp.auth.html" title="Chapter 24. Authentication in the Client Server Protocol">
<link rel="prev" href="ljp.csp.auth.cookies.html" title="2. HTTP Cookies">
<link rel="next" href="ljp.csp.flat.protocol.html" title="Flat Client/Server Protocol Reference">
<meta name="date" content="2008-Jan-15">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">3. Challenge-Response</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ljp.csp.auth.cookies.html">Prev</a> </td>
<th width="60%" align="center">Chapter 24. Authentication in the Client Server Protocol</th>
<td width="20%" align="right"> <a accesskey="n" href="ljp.csp.flat.protocol.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both" id="ljp.csp.auth.challresp">3. Challenge-Response</h2></div></div></div>
<p>Another way to authenticate your client is to build a hex digest consisting of the user's password and
      a challenge as issued by the server. This is currently known as <em class="parameter"><code>auth_method</code></em> &#8220;<span class="quote">challenge</span>&#8221;.</p>
<p>Essentially, you generate a challenge by issuing a blank request to the <code class="methodname">getchallenge</code> method. If your
      method call is successful you're given:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span class="type">string</span> <span class="returnvalue">auth_scheme</span></span></dt>
<dd>You can ignore this for now. By default this is the highest version of our
            authentication schemes, if in the future if we implement other auth schemes or change the default.
            In that case we'd add a new capabilities exchange: Your client could say, "I know c0 and c1", and
            our server would then say, "Use c1, it's the best."</dd>
<dt><span class="term"><span class="type">string</span> <span class="returnvalue">challenge</span></span></dt>
<dd>
<span class="returnvalue">challenge</span> is an opaque cookie, as generated by
          the <code class="function">LJ::challenge_generate</code> sub. Challenges may only be used once.</dd>
<dt><span class="term"><span class="type">int</span> <span class="returnvalue">expire_time</span></span></dt>
<dd>
<span class="returnvalue">expire_time</span> is the expiration time for the challenge
          as measured in seconds since the <span class="application"><code class="systemitem">Unix</code></span> epoch.</dd>
<dt><span class="term"><span class="type">int</span> <span class="returnvalue">server_time</span></span></dt>
<dd>
<span class="returnvalue">server_time</span> is the time of when the challenge was generated,
            as measured in seconds since the <span class="application"><code class="systemitem">Unix</code></span> epoch. The formula (<span class="returnvalue">server_time</span> -
          <span class="returnvalue">expire_time</span>) is the life span of the challenge, in seconds.</dd>
</dl></div>
<p>For your response, you then build a MD5 hex digest of the formula (<span class="returnvalue">challenge</span>
      + MD5_hex(<code class="literal">password</code>)). To authenticate your client now, you simply send back the following 3
      parameters, along with your username:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span class="type">string</span> <em class="parameter"><code>auth_method</code></em></span></dt>
<dd>Set to &#8220;<span class="quote">challenge</span>&#8221;</dd>
<dt><span class="term"><span class="type">string</span> <em class="parameter"><code>auth_challenge</code></em></span></dt>
<dd>The challenge issued by the server</dd>
<dt><span class="term"><span class="type">string</span> <em class="parameter"><code>auth_response</code></em></span></dt>
<dd>MD5_hex(<span class="returnvalue">challenge</span> + MD5_hex(<code class="literal">password</code>))</dd>
</dl></div>
<div class="example">
<a name="example-ljp-challengeauth_script"></a><p class="title"><b>Example 24.2. Sample Perl script using <code class="methodname">getchallenge</code></b></p>
<div class="example-contents"><pre class="programlisting">
use strict;
use Fcntl;
use XMLRPC::Lite;
use Data::Dumper;
use Digest::MD5 qw(md5_hex);

my $xmlrpc = new XMLRPC::Lite;
$xmlrpc-&gt;proxy("http://www.example.com/interface/xmlrpc");
my $get_chal = xmlrpc_call("LJ.XMLRPC.getchallenge");
my $chal = $get_chal-&gt;{'challenge'};

my $user = "test";
my $pass = "pass";
print "chal: $chal\n";

my $response = md5_hex($chal . md5_hex($pass));

my $login = xmlrpc_call('LJ.XMLRPC.login', {
        'username' =&gt; $user,
        'auth_method' =&gt; 'challenge',
        'auth_challenge' =&gt; $chal,
        'auth_response' =&gt; $response,
});

print Dumper($login);

sub xmlrpc_call {
    my ($method, $req) = @_;
    my $res = $xmlrpc-&gt;call($method, $req);
    if ($res-&gt;fault) {
        print STDERR "Error:\n".
        " String: " . $res-&gt;faultstring . "\n" .
        " Code: " . $res-&gt;faultcode . "\n";
        exit 1;
    }
    return $res-&gt;result;
}
      </pre></div>
</div>
<br class="example-break">
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ljp.csp.auth.cookies.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="ljp.csp.auth.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="ljp.csp.flat.protocol.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">2. <code class="systemitem">HTTP</code> Cookies </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Flat Client/Server Protocol Reference</td>
</tr>
</table>
</div>
</body>
</html>
