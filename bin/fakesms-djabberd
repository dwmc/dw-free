#!/usr/bin/perl
# This code was forked from the LiveJournal project owned and operated
# by Live Journal, Inc. The code has been modified and expanded by 
# Dreamwidth Studios, LLC. These files were originally licensed under
# the terms of the license supplied by Live Journal, Inc, which can
# currently be found at:
#
# http://code.livejournal.org/trac/livejournal/browser/trunk/LICENSE-LiveJournal.txt
#
# In accordance with the original license, this code and all its
# modifications are provided under the GNU General Public License. 
# A copy of that license can be found in the LICENSE file included as
# part of this distribution.

use strict;
use lib "$ENV{LJHOME}/cgi-bin";
use lib "$ENV{LJHOME}/src/djabberd/lib";
require 'ljconfig.pl';

use DJabberd;
use DJabberd::Authen::AllowedUsers;
use DJabberd::Authen::StaticPassword;
use DJabberd::Delivery::Local;
use DJabberd::FakeSMS;
use Getopt::Long;

use vars qw($DEBUG);
$DEBUG = 0;

my ($daemonize);

Getopt::Long::GetOptions(
    'd|daemon'       => \$daemonize,
    'debug=i'        => \$DEBUG,
   );

use FindBin qw($Bin);

use DJabberd::VHost;
my $vhost = DJabberd::VHost->new(
                                 server_name => $LJ::DOMAIN,
                                 s2s       => 0,
                                 plugins   => [
                                               DJabberd::Authen::AllowedUsers->new(policy => "deny",
                                                                                   allowedusers => [qr/^\+?\d+/, 'sms']),
                                               DJabberd::Authen::StaticPassword->new(password => "smstest"),
                                               DJabberd::Delivery::FakeSMS->new(),
                                               DJabberd::Delivery::Local->new(),
                                               DJabberd::RosterStorage::FakeSMS->new(),
                                               DJabberd::PresenceChecker::FakeSMS->new(),
                                               ],
                                 );

my $server = DJabberd->new(
                           daemonize => $daemonize,
                           );

$server->add_vhost($vhost);

# incoming
$server->start_simple_server(5224);

$server->run;


