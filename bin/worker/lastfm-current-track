#!/usr/bin/perl

use strict;
use warnings;
use lib "$ENV{LJHOME}/cgi-bin";
require 'ljlib.pl';

use LJ::Worker::Gearman;
use LJ::LastFM;
use Storable qw(freeze thaw); # safe across updating when use with simple structures only
use JSON;

gearman_decl('get_current_track' => \&get_current_track);
gearman_work(save_result => 1);

# get user's current last.fm track
sub get_current_track {
    my $job = shift;
    my $arg = $job->arg; # restricted to be a scalar
    my ( $username ) = @{thaw($arg)};

    return JSON::objToJson( LJ::LastFM::current($username) );
}


1;
